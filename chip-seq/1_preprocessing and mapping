#------------------------------------------------------------------------------------
# Aim: preprocessing of 50-nt single-end ChIP-seq data for further analysis
# Author: Dae Kwan Ko (dkko@msu.edu)
# Last modified: 06-11-2021
# Usage: shown below
#------------------------------------------------------------------------------------

### examples of fastq files
INPUT="/mnt/home/dkko/project_1/1_raw_files/${LINE}_R1_001.fastq.gz"
OUTPUT="/mnt/home/dkko/project_1/3_cleaned_files/${LINE}_cutadapt.fastq"

### m5sum check
md5sum ${INPUT} > ${INPUT}_md5sum.txt

### fastqc of raw data
fastqc -o ${OUTPUT} -f fastq ${INPUT}

### cutadapt
cutadapt -f fastq -q 20,20 -u 2 -m 30 -a AGATCGGAAGAGCACACGTCTGAACTCCAGTCAC \
-g AATGATACGGCGACCACCGAGATCTACACTCTTTCCCTACACGACGCTCTTCCGATCT \
-o ${OUTPUT} ${INPUT}

### fastqc of cleaned data
fastqc -o ${OUTPUT} -f fastq ${INPUT}

### mapping to TAIR10
bowtie -n 2 -m 3 -k 1 --threads 5 --best --chunkmbs 256 -q -S ${GENOME} ${INPUT} > ${OUTPUT}

### flgastat
samtools flagstat ${INPUT} > ${OUTPUT}

### convert bam and keep only mapped reads
samtools view -S ${INPUT} -bF4 -h -o ${OUTPUT} -@ 5

### position sort: markdup needs position order
samtools sort -o ${OUTPUT} ${INPUT}

### markdup
samtools markdup -r -S ${INPUT} ${OUTPUT}

### flgastat
samtools flagstat ${INPUT} > ${OUTPUT}

### final sort after markdup
samtools sort -o ${OUTPUT} ${INPUT}

### index
samtools index ${INPUT}

### 
